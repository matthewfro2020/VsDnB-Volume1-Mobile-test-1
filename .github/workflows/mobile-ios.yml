name: Mobile-iOS

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Haxe
      uses: krdlab/setup-haxe@master
      with:
        haxe-version: 4.3.6

    - name: Install Required Haxelibs
      run: |
        haxelib install hxcpp
        haxelib install lime
        haxelib install openfl
        haxelib install flixel
        haxelib install flixel-ui
        haxelib install flixel-addons
        haxelib install flxanimate
        haxelib install json2object
        haxelib install hscript
        haxelib install polymod
        haxelib git discord_rpc https://github.com/Aidan63/linc_discord-rpc

        # DO NOT INSTALL thx.core (breaks iOS Nil)
        haxelib remove thx.core || true
        haxelib remove thx.error || true
        haxelib remove thx.languages || true

        haxelib install hmm
        haxelib run hmm install

    - name: Patch Polymod for iOS
      run: |
        mkdir -p patched
        cp -r $(haxelib path polymod | head -1)/src/polymod patched/
        rm -rf patched/polymod/hscript/_internal/PolymodInterpEx.hx
        curl -L https://raw.githubusercontent.com/growtopiaguru/polymod-ios-patch/master/PolymodInterpEx.hx -o patched/polymod/hscript/_internal/PolymodInterpEx.hx
        haxelib dev polymod patched/polymod

    - name: Build iOS (No Signing)
      run: |
        haxelib run lime build ios -nosign \
          -D officialBuild \
          -D HXCPP_NO_NIL \
          -D HXCPP_OVERRIDE_NIL \
          -D HXCPP_CPP11 \
          -D ios

    - name: Package IPA
      run: |
        cd export/release/ios/build/*-iphoneos
        mkdir Payload
        mv *.app Payload/
        zip -r build.ipa Payload
        mv build.ipa $GITHUB_WORKSPACE/

    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: ios-ipa
        path: build.ipa
